<!DOCTYPE html>
<html>
<head>
	<title>Chat Multi-usuario con WebRTC</title>
	<script src='/socket.io/socket.io.js'></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
	<style type="text/css">
		/* tamaño de nuestros remotes_videos */
		#list_remote video {
			width: 200px;
			height: 200px;
		}


	</style>
</head>
<body>
	<div class="container">
		<video id="localvideo" autoplay></video>
		<input type="text" name="texto" disabled placeholder="Comunicacion Cerrada" onchange="send_data()">
		<div id='texto'></div>
		<div id="list_remote"></div>
	</div>

<script type="text/javascript">
	//js para la creacion de tag videos de forma automatica
	var list_user=[];
	var list_send=[];
	var streaming;
	var localvideo = document.querySelector('#localvideo');
	var id_newUser;
	var my_id;
  var pc_config = {'iceServers': [{'url': 'stun:stun.l.google.com:19302'}]};
  var receiveChannel;
  var x;
	var items = {
		audio:false,
		video:true
	}

	var name = prompt('Username:');
	//http://192.168.43.136:8181
	// Connect to signalling server
	
	User_ItemMedia();
	
	var socket = io.connect("http://localhost:8181");

	if (streaming != null) {
	  console.log('Joined room streaming with username:', name);
	  socket.emit('stablish_connection',name);
	}

	/*
	Mensaje que se reciben todos los usuarios para conectar el
	audio y el video.
	*/
	socket.on('CreateStream',function(id){
		console.log('Se inicia el proceso ItemMedia.')
		my_id = id;
	});


	/*
	Mensaje que reciben los usuarios que estaban ya en el chat
	antes de este nuevo usuario.
	*/
	socket.on('New_Joined',function(id){
		//recibimos la coneccion de un nuevo usuario
		console.log('El servidor nos notifica que ha entrado un nuevo usuario.')
		id_newUser = id;
		console.log('new_user:'+id_newUser);
		console.log('mu_id:'+my_id);
		create_connection(id_newUser);
	});




	//tratamiento  de los mensajes 
	socket.on('message',function(message){
		console.log('recibimos:');
		console.log(message);
		//evaluo que tipo de mensaje nos llega
		if(message.message.type == 'offer'){
			console.log('Añadimos en create_connection:'+list_user.length);
			//tenemos que constestar a la oferta
			console.log('== OFERTA ==');
			var RTCPeerConnection = window.mozRTCPeerConnection;
			var RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription;
			var pc = new RTCPeerConnection(pc_config,{});
			console.log(streaming);
			x= message.id_origen;
			console.log(list_user.length);
			//añado a la respuesta mi streaming
			pc.addStream(streaming);
			//añadimos a nuestra session la descripcion  que me ha llegado
			pc.setRemoteDescription(new RTCSessionDescription(message.message));
			//enviamos los candidatos

			pc.onicecandidate = function (event){
				console.log(event);
				if(event.candidate){
					var ice = {
						type: 'iceCandidate',
			      label: event.candidate.sdpMLineIndex,
			      id: event.candidate.sdpMid,
			      candidate: event.candidate.candidate
			    };

			    var msg ={
			    	id_origen:my_id,
			    	id_dest:message.id_origen,
			    	message:ice
			    }
			    //enviamos el mensaje
			    console.log('Envimos un mensaje iceCandidate:');
			    console.log(msg);
					socket.emit('message',msg);
				}
			};
			///creamos la respuesta a la oferta
			pc.createAnswer(function(sessionDescription){
				pc.setLocalDescription(sessionDescription);
				var msg = create_msg(my_id,message.id_origen,sessionDescription);
				socket.emit('message',msg);
			},function(err){
				console.log(err);
			},{});


	
			pc.onaddstream = function(event){
				console.log(event);
				///tenemos que crear un nuevo etiqueta video para
				//poder añadir el video que viene en la oferta
				var num_user = 'user_'+ list_user.length;
				console.log('Num user:'+num_user);
				new_remote(num_user);
				var video = document.querySelector('#'+num_user);
				video.mozSrcObject = event.stream;
      	video.play();
      	list_user.push({id:message.id_origen,peer:pc,data:receiveChannel,x:x});
	  	}

	  	//pc implementacion con todas las propiedas
	  	pc.ondatachannel = function(event){
	  		console.log(event)
	  		list_send.push(event.channel);
	  		console.log(list_user.length);
				var receiveChannel = event.channel;
				console.log(receiveChannel);
		  	receiveChannel.onmessage = ChannelReceive;
		  	receiveChannel.onopen = ChannelOpen;
		  	receiveChannel.onclose = ChannelClose;
			}

			console.log(list_user);

		}else if(message.message.type == 'answer'){
			//recibimos un answer
			console.log('Recibimos respuesta añadimos descripcion');
			addAnswer(message.id_origen,message.message);
			
		}else if(message.message.type == 'iceCandidate'){
			//tenemos aue guardar el iceCandidate que recibimos segun el usuario
			console.log('recibimos un icecandidate');
			console.log('Recibimos una ice_candidate:');
 			console.log(message); 
			var candidate = new RTCIceCandidate({sdpMLineIndex:message.message.label,
	      candidate:message.message.candidate});
			addIceCandidate(message.id_origen,candidate);
		}

	});

	//siempre que  un nuevo usuario se conecte al grupo existente
	function create_connection(id){
		console.log('Creamos una conexion con el nuevo usuario.');
		var RTCPeerConnection = window.mozRTCPeerConnection;
		var pc = new RTCPeerConnection(pc_config,{});
		var num_user = 'user_'+ list_user.length;
		console.log('Num user:'+num_user);
		new_remote(num_user);
		//añadimos nuestro streaming para la comunicacion
		pc.addStream(streaming);
		//tenemos que crer un canal de comunicacion de datos
		var sendChannel = pc.createDataChannel("sendDataChannel",
        {reliable: true});

		list_send.push(sendChannel);
		console.log('Cnal creado para datos.')
    console.log(sendChannel);

    //le asignamos los siguientes eventos al canal

    sendChannel.onopen = ChannelOpen;
    sendChannel.onclose = ChannelClose;
    sendChannel.onmessage = ChannelReceive;

		//creamos una oferta para el nuevo usuario
		pc.createOffer(function(sessionDescription){
			//guardamos esto en nuestra session
			pc.setLocalDescription(sessionDescription);
			//enviamos nuestra descripcion al nuevo usuario
			var message = create_msg(my_id,id_newUser,sessionDescription);
			socket.emit('message',message);
			console.log(sessionDescription);
		},function(err){
			console.log(err);
		},{});

		pc.onaddstream = function(event){
			console.log('Añadimos el video remoto.')
			var video = document.querySelector('#'+num_user);
			video.mozSrcObject = event.stream;
      video.play();

		};

		pc.onicecandidate = SendICecandidate;
		//enviamos la oferta al nuevo usuario
		list_user.push({id:id_newUser,peer:pc,data:sendChannel});
		console.log('Añadimos en create_connection:'+list_user.length);
		console.log(list_send)
	
	}



	//funcion para componer mensajes
	function create_msg(id_origen,id_dest,message){
		var msg = {
			id_origen:id_origen,
			id_dest:id_dest,
			message:message
		};
		return msg;
	}

	//atamos el audio y el video
	function User_ItemMedia(){
		//usuamos el video y el microfono de nuestro ordenador
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia 
													|| navigator.mozGetUserMedia || navigator.msGetUserMedia;
		navigator.getUserMedia(items,connect_items,error_items);
	}

	
function SendICecandidate(event){
	console.log(event);
	if(event.candidate){
		var ice = {
			type: 'iceCandidate',
      label: event.candidate.sdpMLineIndex,
      id: event.candidate.sdpMid,
      candidate: event.candidate.candidate
    };

    var msg ={
    	id_origen:my_id,
    	id_dest:id_newUser,
    	message:ice
    }

    //enviamos el mensaje
    console.log('Envimos un mensaje iceCandidate:');
    console.log(msg);
		socket.emit('message',msg);
	}
}

//////////////////////////////////////////////////////
////	functiones auxiliares al proceso principal	///
/////////////////////////////////////////////////////

	function ChannelOpen(){
		//aqui tenemos que desbloquear para que pueda escribir
		console.log('canal abierto');
		$("input").prop('disabled', false);
	}

	function ChannelClose(){
		console.log('canal cerrado');
	}

	function ChannelReceive(event){
		$('#texto').append('<p>'+event.data+'</p>');
		console.log(event.data);
	}

	function send_data(){
		console.log(list_user);
		for(var i=0;i<list_send.length;i++){
			var user = list_send[i];
			user.send(name+':'+'olaaaa');
		}
	}


	function connect_items(stream){
		console.log('conectamos el audio y el video.')
		streaming = stream;
		console.log(streaming);
		localvideo.src = window.URL.createObjectURL(stream);
		console.log('Joined room streaming with username:', name);
	  socket.emit('stablish_connection',name);

	}

	function error_items(error){
		console.log('se ha producido un error');
		console.log(error);
	}

	function new_remote(num_user){
		console.log('se ha creado un nuevo elemento video-remoto')
		$('#list_remote').append('<video id='+num_user+'></video');
	}


	function addAnswer(id,message){
		//buscamos quien me ha envia la respuesta para añadir
		//la sesion remoto
		for(var i=0;i<list_user.length;i++){
			var user = list_user[i];
			if(user.id == id){
				var RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription;
				list_user[i].peer.setRemoteDescription(new RTCSessionDescription(message));
			}
		}
	}

	function addIceCandidate(id,message){
		//buscamos quien me ha envia la respuesta para añadir
		//la sesion remoto
		for(var i=0;i<list_user.length;i++){
			var user = list_user[i];
			if(user.id == id){
				console.log('encontrado')
				user.peer.addIceCandidate(message);
			}
		}
	}

	</script>



</body>
</html>