<!DOCTYPE html>
<html>
<head>
	<title></title>
<script src="astar.js" type="text/javascript"></script>
<style type="text/css">
	#mycanvas{
		background-color: black;
	}
</style>
</head>
<body>
<p>ollaa</p>
<canvas id="mycanvas" style="border:solid"></canvas>
<script type="text/javascript">
 ////primero creamos el aspecto que tendria el ecenario para
//luego calcular los nodos que se vana poder dibujar.
var mycan = document.getElementById('mycanvas');
var context = mycan.getContext('2d');
mycan.width = 32*15;
mycan.height = 32*15;
var coor_pac = {x1:4,y2:8,x:4*32,y:8*32};
var num_pasos = 32;
var puntos=0;

//////////////////
//*** PACMAN ***//
//////////////////
var pacman = {
	x_map:4,
	y_map:8,
	x_real:4*32,
	y_real:8*32,
	width:32,
	height:32,
	move:true,
	speed:0.8,
	num_pasos:32,
	direccion:'x',
	next_direccion:'x',
	puntos:0
	//src:
};


///////////////////////////////////////////
///controlamos el moviemiento del pacman///
///////////////////////////////////////////
var direccion = 'x';
var next_direccion = 'x';
//////////////////////////////

var speed = 0.8;
var move_true = true;

var prueba = true;
var col =15;
var raw = 15;
var map = [
					[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      		[0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,0,1,1,1,1,1,1,1,1,1,0,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,0,1,1,1,1,0,1,1,0,1,0,1,0],
      		[0,1,0,1,1,1,1,0,1,1,0,1,0,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      		[0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],
      		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
			];


var list_obstaculos=[];
var list_cocos=[];

var graph = new Graph(map);
			
var coinImage = new Image();
coinImage.src = "wall.png";

var frame = setInterval(draw_pacman,10);

coinImage.onload= function(){	
	creat_tiles();
}

///////////////////////////////////////////////////////////
//// Movimiento atraves del mapa por ejemplo fantasmas ////
//////////////////////////////////////////////////////////

function draw_pacman(){
	//1.limpiamos canvas
	context.clearRect(0,0,mycanvas.width,mycanvas.height);
	//2.creamos el fondo
	creat_tiles();
	//3.comprobamos si encontramos una pared
	if(parseInt(num_pasos) == 32 || parseInt(num_pasos) == -32 ){
		console.log(num_pasos);
		nex_step(coor_pac);
	}
	
	//4.Actualizamos la nueva coor que dibujamos
	if(direccion == 'x'){
		coor_pac.x += speed;
		num_pasos +=0.8;
	}else if(direccion == '-x'){
		coor_pac.x -= speed;
		num_pasos -=0.8;
	}else if(direccion == 'y'){
		coor_pac.y += speed;
		num_pasos +=0.8;
	}else if(direccion == '-y'){
		coor_pac.y -= speed;
		num_pasos -=0.8;
	}


	//5.dibujamos el pacman
	context.beginPath();
	context.strokeStyle="red";
	context.rect(coor_pac.x,coor_pac.y,32,32);
	context.stroke();
}



///disponibilidad next direccion
function new_direction_avaliable(position){
	var value_node;
	if(position =='x'){
		value_node = map[coor_pac.y2][coor_pac.x1+1];
		console.log('11')
	}else if(position =='-x'){
		value_node = map[coor_pac.y2][coor_pac.x1-1];
		console.log('22')
	}else if(position =='y'){
		value_node = map[coor_pac.y2+1][coor_pac.x1];
		console.log('33')
	}else if(position =='-y'){
		value_node = map[coor_pac.y2-1][coor_pac.x1];
		console.log('44')
	}
	return value_node;
}


function nex_step(elemento){
	var value_step;
	num_pasos = 0;
	///evaluamos el siguiente paso que dara nuestro elemento
	///comprobamos si algun cambiode direccion
	console.log(elemento);
	if(direccion != next_direccion){

		//antes tenemos que comprobar si en la nueva posicion
		//es viable sino seguimos en la misma direccion
		console.log(next_direccion);
		value_step=new_direction_avaliable(next_direccion);
		if(value_step == 0){
			///el siguiente movimiento quiere ir contra una pared
			console.log(value_step)
		}else{
			//cambimos el valor de la direccion pork es un blanco
			direccion = next_direccion;
			console.log(direccion);
		}
	}
	if(direccion == 'x'){
		var new_tile = map[elemento.y2][elemento.x1+1];
		//console.log(new_tile);
		if( new_tile == 0){
			direccion='';
		}else{
			if(new_tile == 1){
				///es un coco por lo que nos lo comemos y cambiamos el valor
				pacman +=4;
				map[elemento.y2][elemento.x1] = -1;
			}
			coor_pac.x1+= 1;
		}
	}else if(direccion == '-x'){
		var new_tile = map[elemento.y2][elemento.x1-1];
		console.log(new_tile);
		if( new_tile == 0){
			direccion='';
		}else{
			if(new_tile == 1){
				///es un coco por lo que nos lo comemos y cambiamos el valor
				pacman +=4;
				map[elemento.y2][elemento.x1] = -1;
			}
			coor_pac.x1-= 1;
		}

	}else if(direccion == 'y'){
		var new_tile = map[elemento.y2+1][elemento.x1];
		console.log(new_tile);
		if( new_tile == 0){
			direccion='';
		}else{
			if(new_tile == 1){
				///es un coco por lo que nos lo comemos y cambiamos el valor
				pacman +=4;
				map[elemento.y2][elemento.x1] = -1;
			}
			coor_pac.y2 += 1;
		}

	}else if(direccion == '-y'){
		var new_tile = map[elemento.y2-1][elemento.x1];
		console.log(new_tile);
		if(new_tile == 0){
			direccion='';
		}else{
			if(new_tile == 1){
				///es un coco por lo que nos lo comemos y cambiamos el valor
				pacman +=4;
				map[elemento.y2][elemento.x1] = -1;
			}
			coor_pac.y2 -= 1;
		}
	}
}

//////////////////////////////////////////////////////////////////
//**** Choque con otros elementos pantasmas u otro elemento ****//
/////////////////////////////////////////////////////////////////
function hit_ghost(){
		var hit = false;
		for(var i=0;i<list_obstaculos.length;i++){
			//*comprobamos que se tiene que cumplir lo siguiente
			var obtaculo = list_obstaculos[i];
			////obstaculo dimensiones
		 	var topObstaculo = obtaculo.y;
		 	var bottomObstaculo = obtaculo.y + 32;
		 	var leftObstaculo = obtaculo.x;
		 	var rigthObstaculo = obtaculo.x + 32;

		 	//dimensiondes de pacman
		 	var myBottom = coor_pac.y+32;
		 	var myTop = coor_pac.y;
		 	var myleft = coor_pac.x;
		 	var myRigth = coor_pac.x+32;

		 	///****** Pasamos a comprobar si existe choque *********
		 	/*console.log('fuera')
		 	console.log(coor_pac)
			console.log('1:'+ myRigth +','+myleft+','+myTop);
			console.log('2:'+rigthObstaculo+','+leftObstaculo+','+ bottomObstaculo);
			console.log(list_obstaculos.length)*/
			//*** pasamos a comprobar que esten en la misma linea ***
			//if(myleft == leftObstaculo && myRigth == rigthObstaculo){

			if(myTop < bottomObstaculo){
				//console.log(myTop +' eee '+ bottomObstaculo)
		 		//console.log("tocamos obstaculo por debajo")
		 		hit = true;
		 		break
			}

			if(myBottom > topObstaculo){
				//console.log("tocamos obstaculo por arriba")
		 		hit = true
		 		break
			}
			//*** Momientos hacia la derecha he izquierda 

			if(myRigth > leftObstaculo){
				//console.log('tocamos al obstaculo por  su izquierda');
				hit = true;
		 		break
			}

			if(myleft < rigthObstaculo){
				//console.log('tocamos al obstaculo por  su derecha');
				hit = true;
		 		break
			}
		//}
	}
}

//////////////////////////////////////////////////
//**** Creamos las paredes de nuestro juego ****//
//////////////////////////////////////////////////
function creat_tiles(){
	for(var i=0;i<15;i++){ //---> es la x
		for(var j=0;j<15;j++){//---> es la y
			var tileid=map[j][i]; //se lee y se escribe el acceso al map [x][y]
			var sourcex = Math.floor(tileid%5)*64;
			//console.log(sourcex)
			//console.log('x:'+Math.floor(tileid%5)*32)
			var sourcey = Math.floor(tileid/5)*64;
			//console.log('y:'+Math.floor(tileid/5)*32)
			if(sourcex == 0){
				//** guardamos los obtaculos **
				var obstaculo = {width:32,height:32,x:i*32,y:j*32};	
				list_obstaculos.push(obstaculo)
				context.drawImage(coinImage,0,0,64,64,i*32,j*32,32,32);
			}else if (sourcex == 64){
				//** guardamos el sitio de los cocos **
				var coco = {radio:2,x:i*32+16,y:j*32+16,color:"white"};
				list_cocos.push(coco);
				context.fillStyle = 'white';
				context.beginPath();
				context.arc(i*32+16,j*32+16,2,0,(Math.PI/180),true);
				context.fill();
			}
		}
	}
}
//////////////////////////////////////////
//*** AÃ±adimos un evento del teclado ***//
/////////////////////////////////////////
document.addEventListener("keydown", NextPosPacman, false);

function NextPosPacman(e){
	console.log(e);
	if(e.code == 'ArrowDown'){
		next_direccion='y';
		if(num_pasos == 0){
			num_pasos=32;
		}
	}else if(e.code == 'ArrowUp'){
		next_direccion='-y';
		if(num_pasos == 0){
			num_pasos=32;
		}
	}else if(e.code == 'ArrowRight'){
		next_direccion='x';
		if(num_pasos == 0){
			num_pasos=32;
		}
	}else if (e.code == 'ArrowLeft'){
		next_direccion='-x';
		if(num_pasos == 0){
			num_pasos=32;
		}
	}
}
/////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////


function valor_mouse_real(event,canvas){
  var rect = canvas.getBoundingClientRect();
  var coordenada = {};
  coordenada.x = event.clientX - rect.left;
  coordenada.y  = event.clientY - rect.top;
  return  coordenada;
}


</script>
</body>
</html>