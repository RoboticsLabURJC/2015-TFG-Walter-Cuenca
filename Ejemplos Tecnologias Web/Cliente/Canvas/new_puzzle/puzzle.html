
<!utilizaremos el estandar de HTML5 >
<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="Style_carrusel.css">
	<link rel="stylesheet" type="text/css" href="Style_btn.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script type="text/javascript">
	//Variables referentes al canvas 
	var context;
	var lienzo;
	var dificultad;
	var imageObj;
	//Variables  referentes al tama√±o del puzzle y de las piezas
	var pieceWidth;
	var pieceHeight;
	var puzzleWidth;
	var puzzleHeight;

	var mode_play = false;

	var info_user=[];


	//Variables necesarias 
	var value_piezas; //esta variable tiene el valor los puntos donde estan cada trozo del puzzle
	var point_mouse = {};// guarda el valor de las coordenadas del raton
	var pos_pieza_push; // nos guardamos la posicion donde esta la pieza pulsada en nuestro array
	var name_puzzle;
	var pieza_push = null;
	/*variables necesarias para tratar los datos del usuario */
	var user = null;
	

	/*variables necesarias para localstorage */

	var pos = 0;
	var segundos = 0;
	/*enlazar bien el cronometro con el contenido.*/
	var contador;

	var img_disponible = ["Hulk.jpg","Cachorro.jpg","Big.jpg","Aguila.jpg","Minions.jpe"];

	var mov_img = setInterval(move_img,1000);

/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

	/*permite obtener la dificultad que el usuario a seleccionado*/
	function select_dificultad(){
		dificultad = document.getElementById("dificultad").value;
		pieceWidth = Math.floor(lienzo.width/dificultad);
		pieceHeight = Math.floor(lienzo.height/dificultad);
		console.log(pieceWidth +" " +pieceHeight);
		var active_btn = check_item();
		if (active_btn == true) {
			btnMode_on();
		}
	}

	/*permite obtener la el nombre que el usuario a seleccionado*/
	function name_user(){
		if(user != null){
			document.getElementById("name").value = user;
		}else {
			user = document.getElementById("name").value;
			console.log(user);
			var active_btn = check_item();
			if (active_btn == true){
				btnMode_on();
			}
			check_users(user);
		}
	}

	/*permite comprobar que el usuario a seleccionado la dificualta y el nombre*/
	function check_item(){
		var check_ok = false;
		if( (dificultad != 0 ) && (user != null)){
			check_ok = true;
		}
		return check_ok;
	}

	/*permite activas los botono para iniciar el puzzle*/
	function btnMode_on(){
		document.getElementById("empezar").disabled = false;
	}

	//funcion asociada a cambiar de imagen del puzzle
	function change_img(src){
		if(mode_play != true){
			inicio(src);
		}
	}

	/*presentamos img_defecto para que el usuario seleccione optiones */
	function inicio(img_defecto){
		lienzo = document.getElementById('mi_canvas');
		context = lienzo.getContext('2d');
		imageObj = new Image();
		imageObj.src = img_defecto;
		imageObj.onload = function(){
			name_puzzle = cut_path(imageObj.src);
			console.log(name_puzzle);
			lienzo.width = imageObj.width;
			lienzo.height = imageObj.height;
			puzzleWidth = imageObj.width;
			puzzleHeight = imageObj.height;
			context.drawImage(imageObj,0,0,imageObj.width,imageObj.height,0,0,puzzleWidth,puzzleHeight);
		}
	}


	function cut_path(src){
		return src.split("/")[5];
	}

/////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////
	
	function piezas(){
		value_piezas = [];
		var point;
		var x = 0;
		var y = 0;
		for(var i = 0; i < dificultad*dificultad;i++){
			point = {};
			point.xs = x;
			point.ys = y;
			value_piezas.push(point);
			console.log(x);
			console.log(puzzleWidth);
			x +=pieceWidth;
			if (x >= puzzleWidth-pieceHeight){
				x =0;
				y += pieceHeight;
			}
		}	
		value_piezas = shuffleArray(value_piezas);
		build_puzzle();
	}

	/*constuye el puzzle */
	function build_puzzle(){
       	context.clearRect(0,0,puzzleWidth,puzzleHeight);
		var pieza;
		var x_act=0;
		var y_act=0;
		console.log(value_piezas);
		for (i=0;i< value_piezas.length;i++){
			pieza = value_piezas[i];
			/*conseguimos guardar en value_puntos nuevas variables del lugar actual donde se colocan*/
			pieza.x_act = x_act;
			pieza.y_act = y_act;
			context.drawImage(imageObj,pieza.xs,pieza.ys,pieceWidth,pieceHeight,pieza.x_act,pieza.y_act,pieceWidth,pieceHeight);
			context.strokeRect(x_act, y_act, pieceWidth,pieceHeight);
            x_act += pieceWidth;
                if(x_act >= puzzleWidth-pieceHeight){
                    x_act = 0;
                    y_act += pieceHeight;
                }
		}
		add_event();
	}

////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

	/*funcion que divide las piezas e inicializa los eventos */
	function add_event(){
		lienzo.addEventListener("mousedown", function(event){
			point_mouse = valor_mouse_real(event,lienzo);
    		for (var i =0; i < value_piezas.length;i++){
    			var pieza = value_piezas[i];
	    		if( point_mouse.mx > pieza.x_act &  point_mouse.mx < (pieza.x_act+ pieceWidth)){
	    			if(point_mouse.my > pieza.y_act & point_mouse.my < (pieza.y_act + pieceHeight)){
	    				context.clearRect(pieza.x_act,pieza.y_act,pieceWidth,pieceHeight);
	    				pos_pieza_push = i;
	    				pieza_push = pieza;
	    				break	
	    			}
	    		}
    		}
		},false);

		lienzo.addEventListener("mousemove", function(event){	
			if(pieza_push != null){
				point_mouse = valor_mouse_real(event,lienzo);
				move_piece();
			}
		},false);

		lienzo.addEventListener("mouseup",function(event){
			console.log("intercambio de piezas");
			//primero tenemos que obtener las coorndedas del raton para encontrar la pieza para cambiar
			for(var i=0; i< value_piezas.length;i++){
				var pieza = value_piezas[i];
				if( point_mouse.mx > pieza.x_act &  point_mouse.mx < (pieza.x_act+ pieceWidth)){
	    			if(point_mouse.my > pieza.y_act & point_mouse.my < (pieza.y_act + pieceHeight)){
	    				var pieza_cambio = {};
	    				context.globalAlpha = 1;
	    				pieza_cambio.xs = pieza.xs;
	    				pieza_cambio.ys = pieza.ys
		    			/*cambiamosel valor de la pieza donde se activa mouseup por la pieza que 
		    			seleccionamos para mover*/
	    				value_piezas[i].xs = pieza_push.xs;
	    				value_piezas[i].ys = pieza_push.ys;
						/*cambiamos el valor de la pieza que se movio por la imagen 
						que activo la funcion mouseup*/
						pieza_push.xs = pieza_cambio.xs;
		    			pieza_push.ys = pieza_cambio.ys;
						break
	    			}
				}
			}
			pieza_push = null;
			update_puzzle();	
		},false);
	}

	/*funcion que actualiza el puzzle cuando movemos una pieza*/
	function move_piece(){
		context.clearRect(0,0,puzzleWidth,puzzleHeight);
			context.fillStyle = 'silver';
			context.globalAlpha = .8;
	    	context.fillRect(0,0,puzzleWidth,puzzleHeight);
		var last_piece = null;
		for (i=0;i< value_piezas.length;i++){
			if(i != pos_pieza_push){
				var pieza = value_piezas[i];
				context.drawImage(imageObj,pieza.xs,pieza.ys,pieceWidth,pieceHeight,pieza.x_act,pieza.y_act,pieceWidth,pieceHeight);
				context.strokeRect(pieza.x_act, pieza.y_act, pieceWidth,pieceHeight);
			}else{
				last_piece = value_piezas[i];
			}
		}
		context.globalAlpha = 1;
		context.drawImage(imageObj,last_piece.xs,last_piece.ys,pieceWidth,pieceHeight,point_mouse.mx,point_mouse.my,pieceWidth,pieceHeight);
		context.strokeRect(last_piece.x_act, last_piece.y_act, pieceWidth,pieceHeight);
	}

	function update_puzzle(){
		context.clearRect(0,0,puzzleWidth,puzzleHeight);
		context.fillStyle = 'silver';
		for (i=0;i< value_piezas.length;i++){
			var pieza = value_piezas[i];
			context.drawImage(imageObj,pieza.xs,pieza.ys,pieceWidth,pieceHeight,pieza.x_act,pieza.y_act,pieceWidth,pieceHeight);
			context.strokeRect(pieza.x_act, pieza.y_act, pieceWidth,pieceHeight);
		}
		comprobar_puzzle();			
	}

	//funcion que desordena un array 
	function shuffleArray(o){
            for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
            return o;
    } 

    /*funcion que me calcula el valor correcto en el que esta el raton de acuerdo a la ventana.*/
    function valor_mouse_real(event,canvas){
    	var rect = canvas.getBoundingClientRect();
    	var coordenada = {};
    	coordenada.mx = event.clientX - rect.left;
    	coordenada.my  = event.clientY - rect.top;
    	return  coordenada;
    }
    /*funcion que comprueba si se ha terminado el puzzle */
    function comprobar_puzzle(){
    	var end = false;
    	for(var i=0;i<value_piezas.length;i++){
    		var pieza = value_piezas[i];
    		console.log(pieza);
    		if((pieza.xs == pieza.x_act) & (pieza.ys == pieza.y_act)){
    			end = true;
    		}else{
    			end = false
    			break
    		}
    	}
    	if(end){
			
			clearInterval(contador);
			var new_info = {difil:dificultad,tempo:segundos,img_puzzle:name_puzzle,terminado:true};
			updateInfo_user(new_info);
			build_final();
    	}
    }

    function build_final(){
    	console.log("Terminado Puzzle");
    	/*dibujamos la imagen con un mensaje sobre ella */
    	context.clearRect(0,0,puzzleWidth,puzzleHeight);
    	context.fillStyle = 'silver';
    	context.drawImage(imageObj,0,0,puzzleWidth ,puzzleHeight,0,0,puzzleWidth,puzzleHeight);
    	/*dibujamos el mensaje de puzzle terminado*/
    	draw_msg();	
	      
    }

    function draw_msg(){
    	context.fillStyle = 'silver';
	    context.globalAlpha = .6;
	    context.fillRect(100,puzzleHeight - 40,puzzleWidth - 200,40);
	    context.font = '40px Arial';
        context.globalAlpha = 1;
        context.textAlign = "center";
        context.textBaseline = "middle";
	    /*pensar en las medidas que se tienen que colocar*/
	    context.fillText('Puzzle Terminado', puzzleWidth/2, puzzleHeight -25); 
    }
    /*funciones relacionadas con localStorage*/

    /*evalua si el usuario existe y si no crea una entrada para este usuario*/
    function check_users(name_user){
    	info_user = localStorage.getItem(name_user);
    	console.log(info_user);
    	if(info_user != null){
    		write_infor(info_user);
    	}else{
    		var items_user = {difil:dificultad,tempo:10000,img_puzzle:"Faro.jpg",terminado:false};
    		info_user = [];
    		info_user.push(items_user);
    		save_user(name_user,info_user);
    	}
    }

    /*escribimos el contenido del usuario en la pagina */
	function write_infor(info_user){
		var info = JSON.parse(info_user);
		$("#user").append('<p><strong>'+user+'</strong></p>');
		$("#user").append('<p><strong>--------------------------</strong></p>');
		for(var i=0; i< info.length ;i++){
			$("#user").append('<p><strong> Puzzle' + i + '</strong></p>');
			$("#user").append('<img src ='+info[i].img_puzzle+'></img>');
			$("#user").append('<p>'+info[i].img_puzzle+'</p>');
			$("#user").append('<p>'+info[i].img_puzzle+'</p>');
			$("#user").append('<p>'+info[i].img_puzzle+'</p>');
		}
	}

	/*guardamos el contenido del usuario en localstorage */
	function save_user(name_user,list_user){
		localStorage.setItem(name_user,JSON.stringify(list_user));
	}

	/*actualizamos el contenido del usuario antes de guardar */
	function updateInfo_user(new_info){
		var encontrado = false;
		for(var i=0; i< info_user.length; i++){
			var puzzle = info_user[i];
			if(puzzle.img_puzzle == new_info.img_puzzle){
				console.log(puzzle.img_puzzle +" "+new_info.img_puzzle);
				console.log(puzzle.tempo +" "+new_info.img_puzzle);
				if(puzzle.tempo > new_info.tempo){
					info_user[i] = new_info;
					console.log(i);
					encontrado = true;
				}	
			}
		}

		if (encontrado == false){
    		info_user.push(new_info);
    		save_user(user,info_user);

		}else{
			save_user(user,info_user);
			var ter = localStorage.getItem(user);
			console.log(ter);
		}
	}

	/*funcion que dibuja un cronometro con canvas*/
	function cronometro(){
		var cronometro = document.getElementById("cronometro");
		var context = cronometro.getContext('2d');
		context.clearRect(0,0,cronometro.width,cronometro.height);
		context.font = '40pt Calibri';
	    context.fillStyle = 'blue';
	    var strin_num = segundos.toString()+ " seg";
	    context.fillText(strin_num, 10, 50);
	    segundos = segundos+1;
	}

	function Init_puzzle(){
		piezas();
		contador = setInterval(cronometro, 1000);
		mode_play = true;
		btnMode_play();
		
	}

	function btnMode_play(){
		document.getElementById("terminar").disabled = false;
		document.getElementById("empezar").disabled = true;
	}

	function End_puzzle(){
		clearInterval(contador);
		mode_play = false;
		/*guardamos la inforacion en storagesesion ya que el usuario a finalizo el puzzle*/
		var new_info = {difil:dificultad,tempo:segundos,img_puzzle:name_puzzle,terminado:false};
		updateInfo_user(new_info);
		/*ensa√±amos al usuario que no a termiando el puzzle */
		document.getElementById("terminar").disabled = true;
		document.getElementById("empezar").disabled = false;

	}

	function move_img(){
		var imagen_1 = document.getElementById("img_1");
		var imagen_2 = document.getElementById("img_2");
		var imagen_3 = document.getElementById("img_3");
		/*intercambiamos el valor de las imagenes */
		imagen_1.src = imagen_2.src;
		imagen_2.src = imagen_3.src;
		if(pos < img_disponible.length){
			img_3.src = img_disponible[pos];
			pos = pos + 1;
		}else{
			pos = 0;
			img_3.src = img_disponible[pos];
		}
	}


</script>
</head>
<body onload="inicio('Hulk.jpg')">
	<header> Puzzle interactivo</header>
	<article id ="cab_arti">
			<section id="inf_arti">
				<div id="canvas">
					<canvas id="mi_canvas"></canvas>
				</div>
				
				<div id="date_init">
					<input placeholder="Dificultad" id ="dificultad" type="number" min="2" max="10" onchange="select_dificultad()">
					<input placeholder="Nombre" id ="name" type ="text" onchange="name_user()">
				</div>
				
				<div id = "carrusel">
					<img id ="img_1" src="Medusa.jpg" onclick="change_img(src)">
					<img id ="img_2" src="Faro.jpg" onclick="change_img(src)">
					<img id ="img_3" src="Hulk.jpg" onclick="change_img(src)">
				</div>
				<div id="botones">
					<button type="button" id ="empezar" onclick="Init_puzzle()" disabled>Empezar</button>
					<button type="button" id = "terminar" onclick="End_puzzle()" disabled>Finalizar</button>
				</div>
				<canvas id="cronometro"></canvas>
				
			</section>
	</article>
	<aside id ="links_pag">
		<div id ="user"></div>
	</aside>
	<footer ></footer>
</body>
</html>