<!DOCTYPE html>
<html>
<head>
 <title>Mapa basico</title>
 <style type="text/css">
 	#googleMap, #streetMap{
 		margin-left: 10px;
 		margin-right: 10px;
        float: left;
        height: 100%;
        width: 45%;
    }

    #panelDirecciones {
    	overflow: scroll;
    	margin-left: 15%;
        float: left;
        height: 20%;
        width: 30%;
    }

    #container{
    	margin-left: 10%;
    }

 </style>

 <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>  
 <script  src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBliq3S6sQ0pJsT1xWJDiMtPuM1sn9xzaM"></script>
 <script>
 	//variables para los marcaores
 	var labels =['A','B','C','D','E','F','G','H'];
 	var num_labels=0;

 	//variables del mapa y coordenada usuario
 	var panorama;
  	var map;
 	var coordenada={};

 	//ventana de informacion del marcador
 	var infowindow;
 	var contentString = "hola Walter";

 	//marcador principal -->> indica la posicion del usuario
 	var marker;


 	///////////////////////////////////////////
 	// Pedimos al usuario la posicion actual //
 	///////////////////////////////////////////
	if (navigator.geolocation) {
		console.log("entramos");
        navigator.geolocation.getCurrentPosition(function(objPosition){
			console.log(position);
			coordenada.lat = objPositionobjPosition.coords.latitude;
			coordenada.lng = objPosition.coords.longitude;
			initialize()
		});
    } else {
   		console.log("no aceptamos");
        x.innerHTML = "Geolocation is not supported by this browser.";
    }

    ///////////////////////////////////////////////////
 	// Funcion que nos permite comprobar algun error //
 	//////////////////////////////////////////////////

	function prueba (err){
		if (err.code == 0) {
            alert("Oops! Algo ha salido mal");
        }
        if (err.code == 1) {
            alert("Oops! No has aceptado compartir tu posición");
        }
        if (err.code == 2) {
            alert("Oops! No se puede obtener la posición actual");
        }
        if (err.code == 3) {
            alert("Oops! Hemos superado el tiempo de espera");
        }
	}

 	/////////////////////////////////////////////////
 	// Funcion que carga el mapa con sus elementos //
 	/////////////////////////////////////////////////

	function initialize(){
	 	console.log(">> obtenemos informacion posicion: "+coordenada.lat+"..."+coordenada.lng);
		var mapProp = {
		    center:new google.maps.LatLng(coordenada.lat,coordenada.lng),
		    zoom:16,
		    mapTypeId:google.maps.MapTypeId.ROADMAP,
		};

		var stretProp={
	  		position:coordenada,
	  		pov:{
	  			heading: 34,
          		pitch: 0
	  		}
	  	}


	  	map=new google.maps.Map(document.getElementById("googleMap"),mapProp);

	  	panorama = new google.maps.StreetViewPanorama(document.getElementById('streetmap'),stretProp);

		marker = new google.maps.Marker({
		    	position: coordenada,
		    	draggable: true,
    			animation: google.maps.Animation.BOUNCE,
		    	map: map,
		   	 	title: 'Double Click to zoom'
		 	 });

		map.addListener("click",function(e){
			console.log(">> Pinchamos el mapa:");
			placeMarkerAndPanTo(e.latLng, map);
		});

		marker.addListener("click",function(e){
			console.log(">> Ha pulsado el marcador:un click")
			playzoom(map);
		});

		infowindow = new google.maps.InfoWindow({
    		content: contentString
  		});

		marker.addListener("mouseover",function(e){
			console.log(">> Colocamos el raton encima de la etiqueta");
			readinfo(map);
		});

		marker.addListener('mouseout',function(e){
			console.log(">> Quitamos el raton de la etiqueta y cerramos info");
			infowindow.close(map,marker);
		});

	}


	google.maps.event.addDomListener(window, 'load', initialize);


	function playzoom(mapa){
		mapa.setZoom(19);
	}

	function readinfo(mapa){
		infowindow.open(mapa, marker);
	}


   function placeMarkerAndPanTo(e,map){
   		if(num_labels < labels.length){
   			console.log(">> Creamos un nuevo marcador en: "+e);
	   		var mark = new google.maps.Marker({
			    position: e,
			    map: map,
			    label:labels[num_labels],
			   	title: String(e)
			});
			map.panTo(e);
			num_labels += 1;
			console.log(num_labels);
   		}else{
			console.log("No se pueden crear mas etiqueta.");
   		}

   		mark.addListener("click",function(e){
   			console.log(">> Calculando ruta desde el origen(P):")
			direction_A_B(map,e)
		});

   		var stretProp={
	  		position:e,
	  		pov:{
	  			heading: 34,
          		pitch: 0
	  		}
	  	}
		panorama = new google.maps.StreetViewPanorama(document.getElementById('streetmap'),stretProp);
		console.log(panorama);
   }

   function direction_A_B(map,e){
	   	var rendererOptions = {
	  		map: map,
	  		suppressMarkers : true
		};
   		var servicioDirecciones = new google.maps.DirectionsService();
	  	var displayDirecciones = new google.maps.DirectionsRenderer(rendererOptions);
	  	displayDirecciones.setPanel($("#panelDirecciones")[0]);
	  	displayDirecciones.setMap(map);


	  	var peticion = {
            origin: coordenada, // Origen
            destination: e.latLng, // Destino
            travelMode: google.maps.TravelMode.DRIVING, // Modo de dirección 
            optimizeWaypoints:true
        };

	  	servicioDirecciones.route(peticion, function(resultado, estado) {
            if (estado == google.maps.DirectionsStatus.OK) {
            	console.log(resultado.geocoded_waypoints);
            	displayDirecciones.setDirections(resultado);
            }
        });
   }




 </script>
</head>
<body>
	<div id="container">
		<div id="googleMap" style="width:500px;height:250px;"></div>
  		<div id="streetmap" style="width:500px;height:250px;"></div>
	</div>
  <div id ="panelDirecciones"></div>
</body>
</html>
